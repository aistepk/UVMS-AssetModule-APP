<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PollServiceBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">asset-module</a> &gt; <a href="index.source.html" class="el_package">eu.europa.ec.fisheries.uvms.mobileterminal.bean</a> &gt; <span class="el_source">PollServiceBean.java</span></div><h1>PollServiceBean.java</h1><pre class="source lang-java linenums">/*
﻿Developed with the contribution of the European Commission - Directorate General for Maritime Affairs and Fisheries
© European Union, 2015-2016.

This file is part of the Integrated Fisheries Data Management (IFDM) Suite. The IFDM Suite is free software: you can
redistribute it and/or modify it under the terms of the GNU General Public License as published by the
Free Software Foundation, either version 3 of the License, or any later version. The IFDM Suite is distributed in
the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details. You should have received a
copy of the GNU General Public License along with the IFDM Suite. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package eu.europa.ec.fisheries.uvms.mobileterminal.bean;

import eu.europa.ec.fisheries.schema.exchange.common.v1.AcknowledgeTypeType;
import eu.europa.ec.fisheries.schema.mobileterminal.polltypes.v1.*;
import eu.europa.ec.fisheries.schema.mobileterminal.types.v1.MobileTerminalType;
import eu.europa.ec.fisheries.schema.mobileterminal.types.v1.PluginCapabilityType;
import eu.europa.ec.fisheries.uvms.asset.bean.AssetServiceBean;
import eu.europa.ec.fisheries.uvms.asset.domain.entity.Asset;
import eu.europa.ec.fisheries.uvms.asset.message.AuditProducer;
import eu.europa.ec.fisheries.uvms.mobileterminal.dao.ChannelDaoBean;
import eu.europa.ec.fisheries.uvms.mobileterminal.dao.PollDaoBean;
import eu.europa.ec.fisheries.uvms.mobileterminal.dao.PollProgramDaoBean;
import eu.europa.ec.fisheries.uvms.mobileterminal.dao.TerminalDaoBean;
import eu.europa.ec.fisheries.uvms.mobileterminal.model.dto.CreatePollResultDto;
import eu.europa.ec.fisheries.uvms.mobileterminal.dto.PollChannelListDto;
import eu.europa.ec.fisheries.uvms.mobileterminal.dto.PollDto;
import eu.europa.ec.fisheries.uvms.mobileterminal.entity.*;
import eu.europa.ec.fisheries.uvms.mobileterminal.entity.types.PollTypeEnum;
import eu.europa.ec.fisheries.uvms.mobileterminal.mapper.*;
import eu.europa.ec.fisheries.uvms.mobileterminal.model.dto.ListResponseDto;
import eu.europa.ec.fisheries.uvms.mobileterminal.model.dto.SimpleCreatePoll;
import eu.europa.ec.fisheries.uvms.mobileterminal.search.PollSearchKeyValue;
import eu.europa.ec.fisheries.uvms.mobileterminal.search.poll.PollSearchMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.ejb.EJB;
import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.inject.Inject;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.*;

@Stateless
@LocalBean
<span class="nc" id="L48">public class PollServiceBean {</span>

<span class="nc" id="L50">    private static final Logger LOG = LoggerFactory.getLogger(PollServiceBean.class);</span>

    @Inject
    private AuditProducer auditProducer;

    @Inject
    private MobileTerminalServiceBean mobileTerminalServiceBean;

    @EJB
    private PluginServiceBean sendPollService;

    @EJB
    private PollDaoBean pollDao;

    @EJB
    private PollProgramDaoBean pollProgramDao;

    @EJB
    private TerminalDaoBean terminalDao;

    @EJB
    private ChannelDaoBean channelDao;

    @Inject
    private AssetServiceBean assetServiceBean;

    public CreatePollResultDto createPollForAsset(UUID assetId, SimpleCreatePoll createPoll, String username){
<span class="nc" id="L77">        MobileTerminal mt = mobileTerminalServiceBean.getActiveMTForAsset(assetId);</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">        if(mt == null) {</span>
<span class="nc" id="L80">            Asset assetById = assetServiceBean.getAssetById(assetId);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            if(assetById == null) {</span>
<span class="nc" id="L82">                throw new IllegalArgumentException(&quot;No asset with id: &quot; + assetId + &quot; found, unable to poll&quot;);</span>
            }
<span class="nc" id="L84">            throw new IllegalArgumentException(&quot;No active MT for asset: &quot; + assetById.getName() + &quot; (&quot; + assetById.getIrcs() + &quot;) , unable to poll&quot;);</span>
        }
<span class="nc" id="L86">        Channel channel = mobileTerminalServiceBean.getPollableChannel(mt);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if(channel == null) {</span>
<span class="nc" id="L88">            throw new IllegalArgumentException(&quot;No pollable channel for this active MT: &quot; + mt.getSerialNo() + &quot; , unable to poll&quot;);</span>
        }

<span class="nc" id="L91">        PollRequestType prt = buildPollRequest(createPoll, username, mt, channel);</span>

<span class="nc" id="L93">        return createPoll(prt);</span>
    }

    private PollRequestType buildPollRequest(SimpleCreatePoll createPoll, String username,
                                             MobileTerminal mt, Channel channel) {
<span class="nc" id="L98">        PollRequestType prt = new PollRequestType();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        prt.setPollType(createPoll.getPollType() != null ? createPoll.getPollType() : PollType.MANUAL_POLL);</span>
<span class="nc" id="L100">        PollMobileTerminal pollMobileTerminal = new PollMobileTerminal();</span>
<span class="nc" id="L101">        pollMobileTerminal.setMobileTerminalId(mt.getId().toString());</span>
<span class="nc" id="L102">        pollMobileTerminal.setComChannelId(channel.getId().toString());</span>
<span class="nc" id="L103">        prt.setUserName(username);</span>
<span class="nc" id="L104">        prt.setComment(createPoll.getComment());</span>
<span class="nc" id="L105">        prt.getMobileTerminals().add(pollMobileTerminal);</span>

<span class="nc" id="L107">        setPollRequestAttributes(prt, createPoll);</span>

<span class="nc" id="L109">        return prt;</span>
    }

    private void setPollRequestAttributes(PollRequestType pollRequest, SimpleCreatePoll createPoll){
<span class="nc bnc" id="L113" title="All 2 branches missed.">        switch (createPoll.getPollType()){</span>
            case PROGRAM_POLL:
<span class="nc" id="L115">                pollRequest.getAttributes().add(createPollAttribute(PollAttributeType.FREQUENCY, &quot;&quot; + createPoll.getFrequency()));</span>
<span class="nc" id="L116">                pollRequest.getAttributes().add(createPollAttribute(PollAttributeType.START_DATE, &quot;&quot; + createPoll.getStartDate().toEpochMilli()));</span>
<span class="nc" id="L117">                pollRequest.getAttributes().add(createPollAttribute(PollAttributeType.END_DATE, &quot;&quot; + createPoll.getEndDate().toEpochMilli()));</span>
<span class="nc" id="L118">                break;</span>
            default:
        }
<span class="nc" id="L121">    }</span>

    private PollAttribute createPollAttribute(PollAttributeType key, String value){
<span class="nc" id="L124">        PollAttribute attribute = new PollAttribute();</span>
<span class="nc" id="L125">        attribute.setKey(key);</span>
<span class="nc" id="L126">        attribute.setValue(value);</span>
<span class="nc" id="L127">        return attribute;</span>
    }

    public CreatePollResultDto createPoll(PollRequestType poll) {

<span class="nc" id="L132">        List&lt;PollResponseType&gt; createdPolls = validateAndCreatePolls(poll);</span>

<span class="nc" id="L134">        List&lt;String&gt; unsentPolls = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L135">        List&lt;String&gt; sentPolls = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        for (PollResponseType createdPoll : createdPolls) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (PollType.PROGRAM_POLL.equals(createdPoll.getPollType())) {</span>
<span class="nc" id="L138">                unsentPolls.add(createdPoll.getPollId().getGuid());</span>
            } else {
<span class="nc" id="L140">                AcknowledgeTypeType ack = sendPollService.sendPoll(createdPoll);</span>
<span class="nc bnc" id="L141" title="All 3 branches missed.">                switch (ack) {</span>
                    case NOK:
<span class="nc" id="L143">                        unsentPolls.add(createdPoll.getPollId().getGuid());</span>
<span class="nc" id="L144">                        break;</span>
                    case OK:
<span class="nc" id="L146">                        sentPolls.add(createdPoll.getPollId().getGuid());</span>
                        break;
                }
            }
            try {
<span class="nc" id="L151">                String auditData = AuditModuleRequestMapper.mapAuditLogPollCreated(createdPoll.getPollType(), createdPoll.getPollId().getGuid(), createdPoll.getComment(), createdPoll.getUserName());</span>
<span class="nc" id="L152">                auditProducer.sendModuleMessage(auditData);</span>
<span class="nc" id="L153">            } catch (Exception e) {</span>
<span class="nc" id="L154">                LOG.error(&quot;Failed to send audit log message! Poll with guid {} was created&quot;, createdPoll.getPollId().getGuid());</span>
<span class="nc" id="L155">            }</span>
<span class="nc" id="L156">        }</span>

<span class="nc" id="L158">        CreatePollResultDto result = new CreatePollResultDto();</span>
<span class="nc" id="L159">        result.setSentPolls(sentPolls);</span>
<span class="nc" id="L160">        result.setUnsentPolls(unsentPolls);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        result.setUnsentPoll(!unsentPolls.isEmpty());</span>
<span class="nc" id="L162">        return result;</span>
    }

    public List&lt;PollDto&gt; getRunningProgramPolls() {
<span class="nc" id="L166">        List&lt;ProgramPoll&gt; pollPrograms = pollProgramDao.getProgramPollsAlive();</span>
<span class="nc" id="L167">        List&lt;PollResponseType&gt; pollResponse = getResponseList(pollPrograms);</span>

<span class="nc" id="L169">        return PollDtoMapper.mapPolls(pollResponse);</span>
    }

    public ProgramPoll startProgramPoll(String pollId, String username) {

<span class="nc" id="L174">        PollId pollIdType = new PollId();</span>
<span class="nc" id="L175">        pollIdType.setGuid(pollId);</span>
<span class="nc" id="L176">        ProgramPoll startedPoll = setStatusPollProgram(pollIdType, ProgramPollStatus.STARTED);</span>
        try {
<span class="nc" id="L178">            String auditData = AuditModuleRequestMapper.mapAuditLogProgramPollStarted(startedPoll.getId().toString(), username);</span>
<span class="nc" id="L179">            auditProducer.sendModuleMessage(auditData);</span>
<span class="nc" id="L180">        } catch (Exception e) {</span>
<span class="nc" id="L181">            LOG.error(&quot;Failed to send audit log message due tue: &quot; + e + &quot;! Poll with guid {} was started&quot;, startedPoll.getId().toString());</span>
<span class="nc" id="L182">        }</span>
<span class="nc" id="L183">        return startedPoll;</span>
    }

    public ProgramPoll stopProgramPoll(String pollId, String username){

<span class="nc" id="L188">        PollId pollIdType = new PollId();</span>
<span class="nc" id="L189">        pollIdType.setGuid(pollId);</span>
<span class="nc" id="L190">        ProgramPoll stoppedPoll = setStatusPollProgram(pollIdType, ProgramPollStatus.STOPPED);</span>
        try {
<span class="nc" id="L192">            String auditData = AuditModuleRequestMapper.mapAuditLogProgramPollStopped(stoppedPoll.getId().toString(), username);</span>
<span class="nc" id="L193">            auditProducer.sendModuleMessage(auditData);</span>
<span class="nc" id="L194">        } catch (Exception e) {</span>
<span class="nc" id="L195">            LOG.error(&quot;Failed to send audit log message due tue: &quot; + e + &quot;! Poll with guid {} was stopped&quot;, stoppedPoll.getId().toString());</span>
<span class="nc" id="L196">        }</span>
<span class="nc" id="L197">        return stoppedPoll;</span>
    }

    public ProgramPoll inactivateProgramPoll(String pollId, String username){

<span class="nc" id="L202">        PollId pollIdType = new PollId();</span>
<span class="nc" id="L203">        pollIdType.setGuid(pollId);</span>
<span class="nc" id="L204">        ProgramPoll inactivatedPoll = setStatusPollProgram(pollIdType, ProgramPollStatus.ARCHIVED);</span>
        try {
<span class="nc" id="L206">            String auditData = AuditModuleRequestMapper.mapAuditLogProgramPollInactivated(inactivatedPoll.getId().toString(), username);</span>
<span class="nc" id="L207">            auditProducer.sendModuleMessage(auditData);</span>
<span class="nc" id="L208">        } catch (Exception e) {</span>
<span class="nc" id="L209">            LOG.error(&quot;Failed to send audit log message due tue: &quot; + e + &quot;! Poll with guid {} was inactivated&quot;, inactivatedPoll.getId().toString());</span>
<span class="nc" id="L210">        }</span>
<span class="nc" id="L211">        return inactivatedPoll;</span>
    }

    public PollChannelListDto getPollBySearchCriteria(PollListQuery query) {
<span class="nc" id="L215">        PollListResponse pollResponse = getPollList(query);</span>
<span class="nc" id="L216">        return PollDtoMapper.pollListResponseToPollChannelListDto(pollResponse);</span>
    }

    private MobileTerminal getMobileTerminalById(UUID guid) {
<span class="nc" id="L220">        return terminalDao.getMobileTerminalById(guid);</span>
    }

    private List&lt;PollResponseType&gt; validateAndCreatePolls(PollRequestType pollRequest) {
<span class="nc" id="L224">        validatePollRequest(pollRequest);</span>
        List&lt;PollResponseType&gt; responseList;
<span class="nc bnc" id="L226" title="All 5 branches missed.">        switch (pollRequest.getPollType()) {</span>
            case PROGRAM_POLL:
<span class="nc" id="L228">                Map&lt;ProgramPoll, MobileTerminal&gt; programPollMap = validateAndMapToProgramPolls(pollRequest);</span>
<span class="nc" id="L229">                responseList = createProgramPolls(programPollMap);</span>
<span class="nc" id="L230">                break;</span>
            case CONFIGURATION_POLL:
<span class="nc" id="L232">                Map&lt;ConfigurationPoll, MobileTerminal&gt; configurationPollMap = validateAndMapToConfigurationPolls(pollRequest);</span>
<span class="nc" id="L233">                responseList = createPolls(configurationPollMap);</span>
<span class="nc" id="L234">                break;</span>
            case MANUAL_POLL:
            case AUTOMATIC_POLL:
<span class="nc" id="L237">                Map&lt;PollBase, MobileTerminal&gt; basePollMap = validateAndMapToBasePolls(pollRequest);</span>
<span class="nc" id="L238">                responseList = createPolls(basePollMap);</span>
<span class="nc" id="L239">                break;</span>
            case SAMPLING_POLL:
<span class="nc" id="L241">                Map&lt;SamplingPoll, MobileTerminal&gt; samplingPollMap = validateAndMapToSamplingPolls(pollRequest);</span>
<span class="nc" id="L242">                responseList = createPolls(samplingPollMap);</span>
<span class="nc" id="L243">                break;</span>
            default:
<span class="nc" id="L245">                LOG.error(&quot;[ Could not decide poll type ] {}&quot;, pollRequest.getPollType());</span>
<span class="nc" id="L246">                throw new IllegalArgumentException(&quot;Could not decide Poll Type when creating polls&quot;);</span>
        }
<span class="nc" id="L248">        return responseList;</span>
    }

    private Map&lt;PollBase, MobileTerminal&gt; validateAndMapToBasePolls(PollRequestType pollRequest) {
<span class="nc" id="L252">        Map&lt;PollBase, MobileTerminal&gt; map = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        for (PollMobileTerminal pollTerminal : pollRequest.getMobileTerminals()) {</span>
<span class="nc" id="L254">            MobileTerminal mobileTerminalEntity = validateAndGetMobileTerminal(pollTerminal);</span>
<span class="nc" id="L255">            checkPollable(mobileTerminalEntity);</span>
<span class="nc" id="L256">            PollBase poll = PollModelToEntityMapper.createPoll(mobileTerminalEntity, pollTerminal.getComChannelId(), pollRequest, PollBase.class);</span>
<span class="nc" id="L257">            map.put(poll, mobileTerminalEntity);</span>
<span class="nc" id="L258">        }</span>
<span class="nc" id="L259">        return map;</span>
    }

    private Map&lt;SamplingPoll, MobileTerminal&gt; validateAndMapToSamplingPolls(PollRequestType pollRequest) {
<span class="nc" id="L263">        Map&lt;SamplingPoll, MobileTerminal&gt; map = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">        for (PollMobileTerminal pollTerminal : pollRequest.getMobileTerminals()) {</span>
<span class="nc" id="L266">            MobileTerminal mobileTerminalEntity = validateAndGetMobileTerminal(pollTerminal);</span>
<span class="nc" id="L267">            validateMobileTerminalPluginCapability(mobileTerminalEntity.getPlugin().getCapabilities(), pollRequest.getPollType(), mobileTerminalEntity.getPlugin().getPluginServiceName());</span>
<span class="nc" id="L268">            checkPollable(mobileTerminalEntity);</span>
<span class="nc" id="L269">            SamplingPoll poll = PollModelToEntityMapper.mapToSamplingPoll(mobileTerminalEntity, pollTerminal.getComChannelId(), pollRequest);</span>
<span class="nc" id="L270">            map.put(poll, mobileTerminalEntity);</span>
<span class="nc" id="L271">        }</span>
<span class="nc" id="L272">        return map;</span>
    }

    private Map&lt;ConfigurationPoll, MobileTerminal&gt; validateAndMapToConfigurationPolls(PollRequestType pollRequest) {
<span class="nc" id="L276">        Map&lt;ConfigurationPoll, MobileTerminal&gt; map = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L278" title="All 2 branches missed.">        for (PollMobileTerminal pollTerminal : pollRequest.getMobileTerminals()) {</span>
<span class="nc" id="L279">            MobileTerminal mobileTerminalEntity = validateAndGetMobileTerminal(pollTerminal);</span>

<span class="nc" id="L281">            validateMobileTerminalPluginCapability(mobileTerminalEntity.getPlugin().getCapabilities(), pollRequest.getPollType(), mobileTerminalEntity.getPlugin().getPluginServiceName());</span>
<span class="nc" id="L282">            checkPollable(mobileTerminalEntity);</span>
<span class="nc" id="L283">            ConfigurationPoll poll = PollModelToEntityMapper.mapToConfigurationPoll(mobileTerminalEntity, pollTerminal.getComChannelId(), pollRequest);</span>
<span class="nc" id="L284">            map.put(poll, mobileTerminalEntity);</span>
<span class="nc" id="L285">        }</span>
<span class="nc" id="L286">        return map;</span>
    }

    private MobileTerminal validateAndGetMobileTerminal(PollMobileTerminal pollTerminal) {
<span class="nc" id="L290">        MobileTerminal mobileTerminalEntity = terminalDao.getMobileTerminalById(UUID.fromString(pollTerminal.getMobileTerminalId()));</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (mobileTerminalEntity == null) {</span>
<span class="nc" id="L292">            throw new IllegalArgumentException(&quot;No mobile terminal connected to this poll request or the mobile terminal can not be found, for mobile terminal id: &quot; + pollTerminal.getMobileTerminalId());</span>
        }
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if(mobileTerminalEntity.getAsset() == null){</span>
<span class="nc" id="L295">            throw new IllegalArgumentException(&quot;This mobile terminal is not connected to any asset&quot;);</span>
        }
<span class="nc" id="L297">        return mobileTerminalEntity;</span>
    }

    private void validatePollRequest(PollRequestType pollRequest) {
<span class="nc bnc" id="L301" title="All 4 branches missed.">        if (pollRequest == null || pollRequest.getPollType() == null) {</span>
<span class="nc" id="L302">            throw new IllegalArgumentException(&quot;No polls to create&quot;);</span>
        }
<span class="nc bnc" id="L304" title="All 4 branches missed.">        if (pollRequest.getUserName() == null || pollRequest.getUserName().isEmpty()) {</span>
<span class="nc" id="L305">            throw new IllegalArgumentException(&quot;Cannot create poll without a user&quot;);</span>
        }
<span class="nc bnc" id="L307" title="All 4 branches missed.">        if (pollRequest.getComment() == null || pollRequest.getComment().isEmpty()) {</span>
<span class="nc" id="L308">            throw new IllegalArgumentException(&quot;Cannot create poll without a comment&quot;);</span>
        }
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (pollRequest.getMobileTerminals().isEmpty()) {</span>
<span class="nc" id="L311">            throw new IllegalArgumentException(&quot;No mobile terminals for &quot; + pollRequest.getPollType());</span>
        }
<span class="nc" id="L313">    }</span>

    private Map&lt;ProgramPoll, MobileTerminal&gt; validateAndMapToProgramPolls(PollRequestType pollRequest) {
<span class="nc" id="L316">        Map&lt;ProgramPoll, MobileTerminal&gt; map = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L318" title="All 2 branches missed.">        for (PollMobileTerminal pollTerminal : pollRequest.getMobileTerminals()) {</span>
<span class="nc" id="L319">            MobileTerminal mobileTerminalEntity = terminalDao.getMobileTerminalById(UUID.fromString(pollTerminal.getMobileTerminalId()));</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            if(mobileTerminalEntity == null){</span>
<span class="nc" id="L321">                throw new IllegalArgumentException(&quot;No mobile terminal connected to this poll request or the mobile terminal can not be found, for mobile terminal id: &quot; + pollTerminal.getMobileTerminalId());</span>
            }
<span class="nc bnc" id="L323" title="All 2 branches missed.">            if(mobileTerminalEntity.getAsset() == null){</span>
<span class="nc" id="L324">                throw new IllegalArgumentException(&quot;This mobile terminal is not connected to any asset&quot;);</span>
            }
<span class="nc" id="L326">            checkPollable(mobileTerminalEntity);</span>
<span class="nc" id="L327">            ProgramPoll programPoll = PollModelToEntityMapper.mapToProgramPoll(mobileTerminalEntity, pollTerminal.getComChannelId(), pollRequest);</span>
<span class="nc" id="L328">            map.put(programPoll, mobileTerminalEntity);</span>
<span class="nc" id="L329">        }</span>
<span class="nc" id="L330">        return map;</span>
    }

    private void checkPollable(MobileTerminal terminal){
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (terminal.getArchived()) {</span>
<span class="nc" id="L335">            throw new IllegalStateException(&quot;Terminal is archived&quot;);</span>
        }
<span class="nc bnc" id="L337" title="All 2 branches missed.">        if (!terminal.getActive()) {</span>
<span class="nc" id="L338">            throw new IllegalStateException(&quot;Terminal is inactive&quot;);</span>
        }
<span class="nc bnc" id="L340" title="All 4 branches missed.">        if (terminal.getPlugin() != null &amp;&amp; terminal.getPlugin().getPluginInactive()) {</span>
<span class="nc" id="L341">            throw new IllegalStateException(&quot;Terminal connected to no longer active Plugin (LES)&quot;);</span>
        }
<span class="nc" id="L343">    }</span>

    private void validateMobileTerminalPluginCapability (Set&lt;MobileTerminalPluginCapability&gt; capabilities, PollType pollType, String pluginServiceName) {
        PluginCapabilityType pluginCapabilityType;
<span class="nc bnc" id="L347" title="All 3 branches missed.">        switch (pollType) {</span>
            case CONFIGURATION_POLL:
<span class="nc" id="L349">                pluginCapabilityType = PluginCapabilityType.CONFIGURABLE;</span>
<span class="nc" id="L350">                break;</span>
            case SAMPLING_POLL:
<span class="nc" id="L352">                pluginCapabilityType = PluginCapabilityType.SAMPLING;</span>
<span class="nc" id="L353">                break;</span>
            default:
<span class="nc" id="L355">                throw new IllegalArgumentException(&quot;Cannot create &quot; + pollType.name() + &quot;  poll when plugin: &quot; + pluginServiceName);</span>
        }
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!validatePluginHasCapabilityConfigurable(capabilities, pluginCapabilityType)) {</span>
<span class="nc" id="L358">            throw new IllegalArgumentException(&quot;Cannot create &quot; + pollType.name() + &quot;  poll when plugin: &quot; + pluginServiceName + &quot; has not capability &quot; + pluginCapabilityType.name() + &quot; set&quot;);</span>
        }
<span class="nc" id="L360">    }</span>

    private boolean validatePluginHasCapabilityConfigurable (Set&lt;MobileTerminalPluginCapability&gt; capabilities, PluginCapabilityType pluginCapability) {
<span class="nc bnc" id="L363" title="All 2 branches missed.">        for (MobileTerminalPluginCapability pluginCap : capabilities) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">            if (pluginCapability.name().equalsIgnoreCase(pluginCap.getName())) {</span>
<span class="nc" id="L365">                return true;</span>
            }
<span class="nc" id="L367">        }</span>
<span class="nc" id="L368">        return false;</span>
    }

    private List&lt;PollResponseType&gt; createProgramPolls(Map&lt;ProgramPoll, MobileTerminal&gt; map) {
<span class="nc" id="L372">        List&lt;PollResponseType&gt; responseList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">        for (Map.Entry&lt;ProgramPoll, MobileTerminal&gt; next : map.entrySet()) {</span>
<span class="nc" id="L374">            ProgramPoll pollProgram = next.getKey();</span>
<span class="nc" id="L375">            pollProgramDao.createProgramPoll(pollProgram);</span>
<span class="nc" id="L376">            responseList.add(PollEntityToModelMapper.mapToPollResponseType(pollProgram));</span>
<span class="nc" id="L377">        }</span>
<span class="nc" id="L378">        return responseList;</span>
    }

    private List&lt;PollResponseType&gt; createPolls(Map&lt;? extends PollBase, MobileTerminal&gt; map) {
<span class="nc" id="L382">        List&lt;PollResponseType&gt; responseList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">        for (Map.Entry&lt;? extends PollBase, MobileTerminal&gt; next : map.entrySet()) {</span>
<span class="nc" id="L384">            MobileTerminal mobileTerminal = next.getValue();</span>
            PollResponseType pollResponseType;
<span class="nc bnc" id="L386" title="All 4 branches missed.">            switch (next.getKey().getPollTypeEnum()) {</span>
                case SAMPLING_POLL:
<span class="nc" id="L388">                    SamplingPoll samplingPoll = (SamplingPoll) next.getKey();</span>
<span class="nc" id="L389">                    pollDao.createPoll(samplingPoll);</span>
<span class="nc" id="L390">                    pollResponseType = PollEntityToModelMapper.mapToPollResponseType(samplingPoll, mobileTerminal);</span>
<span class="nc" id="L391">                    responseList.add(pollResponseType);</span>
<span class="nc" id="L392">                    break;</span>
                case MANUAL_POLL:
                case AUTOMATIC_POLL:
<span class="nc" id="L395">                    PollBase pollBase = next.getKey();</span>
<span class="nc" id="L396">                    pollDao.createPoll(pollBase);</span>
<span class="nc" id="L397">                    pollResponseType = PollEntityToModelMapper.mapToPollResponseType(pollBase, mobileTerminal);</span>
<span class="nc" id="L398">                    responseList.add(pollResponseType);</span>
<span class="nc" id="L399">                    break;</span>
                case CONFIGURATION_POLL:
<span class="nc" id="L401">                    ConfigurationPoll configurationPoll = (ConfigurationPoll) next.getKey();</span>
<span class="nc" id="L402">                    pollDao.createPoll(configurationPoll);</span>
<span class="nc" id="L403">                    pollResponseType = PollEntityToModelMapper.mapToPollResponseType(configurationPoll, mobileTerminal);</span>
<span class="nc" id="L404">                    responseList.add(pollResponseType);</span>
<span class="nc" id="L405">                    break;</span>
                default:
<span class="nc" id="L407">                    throw new RuntimeException(&quot;Invalid Poll Type. Poll not created!&quot;);</span>
            }
<span class="nc" id="L409">        }</span>
<span class="nc" id="L410">        return responseList;</span>
    }

    public PollListResponse getPollList(PollListQuery query) {
<span class="nc" id="L414">        validatePollListQuery(query);</span>
<span class="nc" id="L415">        PollListResponse response = new PollListResponse();</span>
<span class="nc" id="L416">        List&lt;PollResponseType&gt; pollResponseList = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L418">        Integer page = query.getPagination().getPage();</span>
<span class="nc" id="L419">        Integer listSize = query.getPagination().getListSize();</span>
<span class="nc" id="L420">        boolean isDynamic = query.getPollSearchCriteria().isIsDynamic();</span>
<span class="nc" id="L421">        List&lt;PollSearchKeyValue&gt; searchKeys = PollSearchMapper.createSearchFields(query.getPollSearchCriteria().getCriterias());</span>

<span class="nc" id="L423">        PollTypeEnum pollTypeEnum = getPollTypeFromQuery(query);</span>

<span class="nc" id="L425">        String countSql = PollSearchMapper.createCountSearchSql(searchKeys, isDynamic, pollTypeEnum);</span>
<span class="nc" id="L426">        String sql = PollSearchMapper.createSelectSearchSql(searchKeys, isDynamic, pollTypeEnum);</span>

<span class="nc" id="L428">        Long numberMatches = pollDao.getPollListSearchCount(countSql, searchKeys);</span>
<span class="nc" id="L429">        List&lt;PollBase&gt; pollList = pollDao.getPollListSearchPaginated(page, listSize, sql, searchKeys);</span>

<span class="nc bnc" id="L431" title="All 2 branches missed.">        for (PollBase poll : pollList) {</span>
            try {
<span class="nc" id="L433">                MobileTerminal mobileTerminalEntity = poll.getMobileterminal();</span>
<span class="nc" id="L434">                MobileTerminal mobileTerminal = getMobileTerminalById(mobileTerminalEntity.getId());</span>

<span class="nc" id="L436">                PollResponseType pollType = PollEntityToModelMapper.mapToPollResponseType(poll, mobileTerminal);</span>
<span class="nc" id="L437">                pollResponseList.add(pollType);</span>
<span class="nc" id="L438">            } catch (RuntimeException e) {</span>
<span class="nc" id="L439">                LOG.error(&quot;[ Poll &quot; + poll.getId() + &quot;  couldn't map type ]&quot;);</span>
<span class="nc" id="L440">                throw new RuntimeException(e);</span>
<span class="nc" id="L441">            }</span>
<span class="nc" id="L442">        }</span>

<span class="nc" id="L444">        int numberOfPages = (int) (numberMatches / listSize);</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (numberMatches % listSize != 0) {</span>
<span class="nc" id="L446">            numberOfPages += 1;</span>
        }

<span class="nc" id="L449">        response.setTotalNumberOfPages(numberOfPages);</span>
<span class="nc" id="L450">        response.setCurrentPage(query.getPagination().getPage());</span>
<span class="nc" id="L451">        response.getPollList().addAll(pollResponseList);</span>
<span class="nc" id="L452">        return response;</span>
    }

    private PollTypeEnum getPollTypeFromQuery(PollListQuery query) {
<span class="nc" id="L456">        Optional&lt;ListCriteria&gt; optional = query.getPollSearchCriteria().getCriterias()</span>
<span class="nc" id="L457">                .stream().filter(c -&gt; c.getKey().equals(SearchKey.POLL_TYPE)).findAny();</span>
<span class="nc" id="L458">        return optional.map(listCriteria -&gt; PollTypeEnum.valueOf(listCriteria.getValue())).orElse(PollTypeEnum.BASE_POLL);</span>
    }

    private void validatePollListQuery(PollListQuery query) {
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (query == null) {</span>
<span class="nc" id="L463">            throw new NullPointerException(&quot;Cannot get poll list because no query.&quot;);</span>
        }
<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (query.getPagination() == null) {</span>
<span class="nc" id="L466">            throw new NullPointerException(&quot;Cannot get poll list because no list pagination.&quot;);</span>
        }
<span class="nc bnc" id="L468" title="All 4 branches missed.">        if (query.getPollSearchCriteria() == null || query.getPollSearchCriteria().getCriterias() == null) {</span>
<span class="nc" id="L469">            throw new NullPointerException(&quot;Cannot get poll list because criteria are null.&quot;);</span>
        }
<span class="nc" id="L471">    }</span>

    public List&lt;ProgramPoll&gt; getPollProgramRunningAndStarted() {
<span class="nc" id="L474">        return pollProgramDao.getProgramPollRunningAndStarted();</span>
    }

    public ProgramPoll setStatusPollProgram(PollId id, ProgramPollStatus state) {
<span class="nc bnc" id="L478" title="All 6 branches missed.">        if (id == null || id.getGuid() == null || id.getGuid().isEmpty()) {</span>
<span class="nc" id="L479">            throw new NullPointerException(&quot;No poll id given&quot;);</span>
        }
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (state == null) {</span>
<span class="nc" id="L482">            throw new NullPointerException(&quot;No status to set&quot;);</span>
        }

<span class="nc" id="L485">        ProgramPoll program = pollProgramDao.getProgramPollByGuid(id.getGuid());</span>

<span class="nc bnc" id="L487" title="All 2 branches missed.">        switch (program.getPollState()) {</span>
            case ARCHIVED:
<span class="nc" id="L489">                throw new IllegalArgumentException(&quot;Can not change status of archived program poll, id: [ &quot; + id.getGuid() + &quot; ]&quot;);</span>
            case STARTED:
            case STOPPED:
        }

        // TODO: check terminal/comchannel?

<span class="nc" id="L496">        program.setPollState(state);</span>

<span class="nc" id="L498">        return program;</span>
    }

    public ListResponseDto getMobileTerminalPollableList(PollableQuery query) {
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (query == null) {</span>
<span class="nc" id="L503">            throw new NullPointerException(&quot;No query&quot;);</span>
        }

<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (query.getPagination() == null) {</span>
<span class="nc" id="L507">            throw new NullPointerException(&quot;No list pagination&quot;);</span>
        }

<span class="nc" id="L510">        ListResponseDto response = new ListResponseDto();</span>
<span class="nc" id="L511">        List&lt;MobileTerminalType&gt; mobileTerminalList = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L513">        int page = query.getPagination().getPage();</span>
<span class="nc" id="L514">        int listSize = query.getPagination().getListSize();</span>
<span class="nc" id="L515">        int startIndex = (page - 1) * listSize;</span>
<span class="nc" id="L516">        int stopIndex = startIndex + listSize;</span>
<span class="nc" id="L517">        LOG.debug(&quot;page: &quot; + page + &quot;, listSize: &quot; + listSize + &quot;, startIndex: &quot; + startIndex);</span>

<span class="nc" id="L519">        List&lt;String&gt; idList = query.getConnectIdList();</span>
<span class="nc" id="L520">        long in = System.currentTimeMillis();</span>

<span class="nc" id="L522">        List&lt;Channel&gt; channels = channelDao.getPollableListSearch(idList);</span>

<span class="nc bnc" id="L524" title="All 2 branches missed.">        for (Channel comchannel : channels) {</span>
            //TODO slim response from Pollable
<span class="nc" id="L526">            MobileTerminalType terminal = MobileTerminalEntityToModelMapper.mapToMobileTerminalType(comchannel.getMobileTerminal());</span>
<span class="nc" id="L527">            mobileTerminalList.add(terminal);</span>
<span class="nc" id="L528">        }</span>

<span class="nc" id="L530">        int numberMatches = mobileTerminalList.size();</span>

<span class="nc" id="L532">        int numberOfPages = (numberMatches / listSize);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if (numberMatches % listSize != 0) {</span>
<span class="nc" id="L534">            numberOfPages += 1;</span>
        }

<span class="nc bnc" id="L537" title="All 2 branches missed.">        if ((numberMatches - 1) &lt;= 0) {</span>
<span class="nc" id="L538">            response.setMobileTerminalList(mobileTerminalList);</span>
        } else {
<span class="nc bnc" id="L540" title="All 2 branches missed.">            if (stopIndex &gt;= numberMatches) {</span>
<span class="nc" id="L541">                stopIndex = numberMatches;</span>
            }
<span class="nc" id="L543">            LOG.debug(&quot;stopIndex: &quot; + stopIndex);</span>
<span class="nc" id="L544">            List&lt;MobileTerminalType&gt; newList = new ArrayList&lt;&gt;(mobileTerminalList.subList(startIndex, stopIndex));</span>
<span class="nc" id="L545">            response.setMobileTerminalList(newList);</span>
        }

<span class="nc" id="L548">        response.setTotalNumberOfPages(numberOfPages);</span>
<span class="nc" id="L549">        response.setCurrentPage(query.getPagination().getPage());</span>

<span class="nc" id="L551">        long out = System.currentTimeMillis();</span>
<span class="nc" id="L552">        LOG.debug(&quot;Get pollable channels &quot; + (out - in) + &quot; ms&quot;);</span>
<span class="nc" id="L553">        return response;</span>
    }

    private List&lt;PollResponseType&gt; getResponseList(List&lt;ProgramPoll&gt; pollPrograms)  {
<span class="nc" id="L557">        List&lt;PollResponseType&gt; responseList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        for (ProgramPoll pollProgram : pollPrograms) {</span>
<span class="nc" id="L559">            responseList.add(PollEntityToModelMapper.mapToPollResponseType(pollProgram));</span>
<span class="nc" id="L560">        }</span>
<span class="nc" id="L561">        return responseList;</span>
    }

    public List&lt;PollBase&gt; getAllPollsForAssetForTheLastDay(UUID assetId){
<span class="nc" id="L565">        return pollDao.findByAssetInTimespan(assetId, Instant.now().minus(1, ChronoUnit.DAYS), Instant.now());</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>